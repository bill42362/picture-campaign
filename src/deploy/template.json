{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Formation test.",
  "Parameters" : {
    "CNAMEs" : {
      "Type" : "CommaDelimitedList",
      "Default": "",
      "Description" : "Enter CNAMEs for cloudfront distribution config."
    }
  },
  "Conditions": {
    "HasCNAMEs": { "Fn::Not": [ { "Fn::Equals": [ "", { "Fn::Join": [ ",", { "Ref": "CNAMEs" } ] } ] } ] }
  },
  "Resources" : {
    "S3Bucket" : {
      "Type" : "AWS::S3::Bucket",
      "Properties" : {
        "BucketName": {
            "Fn::Join": [ "", [ {"Ref": "AWS::StackName"}, "-s3-bucket"] ]
        },
        "BucketEncryption" : {
            "ServerSideEncryptionConfiguration" : [
                {
                    "ServerSideEncryptionByDefault" : {
                        "SSEAlgorithm": "AES256"
                    }
                }
            ]
        },
        "AccessControl" : "PublicRead",
        "WebsiteConfiguration" : {
          "IndexDocument" : "index.html"
         }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayRestApi" : {
      "Type" : "AWS::ApiGateway::RestApi",
      "Properties" : {
          "Name": {
              "Fn::Join": [ "", [ {"Ref": "AWS::StackName"}, "-api-gateway"] ]
          },
          "BinaryMediaTypes": [ "image/*", "application/font-*", "application/x-font-*" ],
          "EndpointConfiguration": {
              "Types": [ "EDGE" ]
          }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayRootMethod" : {
      "Type" : "AWS::ApiGateway::Method",
      "Properties" : {
          "HttpMethod": "GET",
          "AuthorizationType": "NONE",
          "Integration": {
              "Type": "HTTP_PROXY",
              "IntegrationHttpMethod": "GET",
              "Uri": { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] }
          },
          "ResourceId": { "Fn::GetAtt": [ "ApiGatewayRestApi", "RootResourceId" ] },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayJsRootResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "js",
          "ParentId": { "Fn::GetAtt": [ "ApiGatewayRestApi", "RootResourceId" ] },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayJsResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "{filename+}",
          "ParentId": { "Ref": "ApiGatewayJsRootResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayJsMethod" : {
      "Type" : "AWS::ApiGateway::Method",
      "Properties" : {
          "HttpMethod": "GET",
          "AuthorizationType": "NONE",
          "Integration": {
              "Type": "HTTP_PROXY",
              "IntegrationHttpMethod": "GET",
              "Uri": { "Fn::Join": [ "", [ { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] }, "/js/{filename}" ] ] }
          },
          "ResourceId": { "Ref": "ApiGatewayJsResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayCssRootResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "css",
          "ParentId": { "Fn::GetAtt": [ "ApiGatewayRestApi", "RootResourceId" ] },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayCssResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "{filename+}",
          "ParentId": { "Ref": "ApiGatewayCssRootResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayCssMethod" : {
      "Type" : "AWS::ApiGateway::Method",
      "Properties" : {
          "HttpMethod": "GET",
          "AuthorizationType": "NONE",
          "Integration": {
              "Type": "HTTP_PROXY",
              "IntegrationHttpMethod": "GET",
              "Uri": { "Fn::Join": [ "", [ { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] }, "/css/{filename}" ] ] }
          },
          "ResourceId": { "Ref": "ApiGatewayCssResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayRouterOrOthersRootResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "{router}",
          "ParentId": { "Fn::GetAtt": [ "ApiGatewayRestApi", "RootResourceId" ] },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayRouterMethod" : {
      "Type" : "AWS::ApiGateway::Method",
      "Properties" : {
          "HttpMethod": "GET",
          "AuthorizationType": "NONE",
          "Integration": {
              "Type": "HTTP_PROXY",
              "IntegrationHttpMethod": "GET",
              "Uri": { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] }
          },
          "ResourceId": { "Ref": "ApiGatewayRouterOrOthersRootResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayOthersResource" : {
      "Type" : "AWS::ApiGateway::Resource",
      "Properties" : {
          "PathPart": "{filename+}",
          "ParentId": { "Ref": "ApiGatewayRouterOrOthersRootResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayOthersMethod" : {
      "Type" : "AWS::ApiGateway::Method",
      "Properties" : {
          "HttpMethod": "GET",
          "AuthorizationType": "NONE",
          "Integration": {
              "Type": "HTTP",
              "IntegrationHttpMethod": "GET",
              "ContentHandling": "CONVERT_TO_BINARY",
              "Uri": { "Fn::Join": [ "", [ { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] }, "/{router}/{filename}" ] ] }
          },
          "ResourceId": { "Ref": "ApiGatewayOthersResource" },
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "ApiGatewayDeployment" : {
      "DependsOn": [
          "ApiGatewayRootMethod",
          "ApiGatewayJsMethod",
          "ApiGatewayCssMethod",
          "ApiGatewayRouterMethod",
          "ApiGatewayOthersMethod"
      ],
      "Type" : "AWS::ApiGateway::Deployment",
      "Properties" : {
          "StageName": "prod",
          "RestApiId": { "Ref": "ApiGatewayRestApi" }
      },
      "DeletionPolicy" : "Delete"
    },
    "CloudFrontDistribution" : {
      "Type" : "AWS::CloudFront::Distribution",
      "Properties" : {
          "DistributionConfig": {
              "Origins": [
                {
                    "DomainName": {
                      "Fn::Join" : [ "", [
                          { "Ref" : "ApiGatewayRestApi" },
                          ".execute-api.",
                          { "Ref" : "AWS::Region" },
                          ".amazonaws.com"
                      ] ]
                    },
                    "OriginPath": "/prod",
                    "Id": "s3-api-gateway",
                    "CustomOriginConfig": {
                        "OriginProtocolPolicy": "https-only"
                    }
                }
              ],
              "DefaultCacheBehavior": {
                  "TargetOriginId": "s3-api-gateway",
                  "ViewerProtocolPolicy": "redirect-to-https",
                  "AllowedMethods": [ "HEAD", "GET" ],
                  "DefaultTTL": 600,
                  "MaxTTL": 3600,
                  "MinTTL": 0,
                  "ForwardedValues": {
                      "QueryString": false
                  },
                  "Compress": true
              },
              "Aliases": { "Fn::If": [ "HasCNAMEs", { "Ref": "CNAMEs" }, { "Ref": "AWS::NoValue" } ] },
              "HttpVersion": "http2",
              "IPV6Enabled": true,
              "Enabled": true
          }
      },
      "DeletionPolicy" : "Delete"
    }
  },
  "Outputs" : {
    "ApiGatewayInvokeURL" : {
      "Value" : { "Ref": "ApiGatewayRestApi" },
      "Value" : { "Fn::Join" : [ "", [
          "https://",
          { "Ref" : "ApiGatewayRestApi" },
          ".execute-api.",
          { "Ref" : "AWS::Region" },
          ".amazonaws.com/prod"
      ] ] },
      "Description" : "URL for website routed by api gateway"
    },
    "WebsiteURL" : {
      "Value" : { "Fn::GetAtt" : [ "S3Bucket", "WebsiteURL" ] },
      "Description" : "URL for website hosted on S3"
    },
    "S3BucketSecureURL" : {
      "Value" : { "Fn::Join" : [ "", [ "https://", { "Fn::GetAtt" : [ "S3Bucket", "DomainName" ] } ] ] },
      "Description" : "Name of S3 bucket to hold website content"
    }
  } 
}
